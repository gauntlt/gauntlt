#!/usr/bin/env ruby
require 'rubygems'
require 'trollop'

$:.push File.expand_path("../../lib", __FILE__) unless $:.include?( File.expand_path("../../lib", __FILE__) )
require 'gauntlt'

opts = Trollop::options do
  version Gauntlt::VERSION
  banner <<-EOS
gauntlt is a ruggedization framework

Usage:
       gauntlt <path>+ [--tags TAG_EXPRESSION]

Options:
EOS

  opt :tags, "Only execute specified tags",
      :type => String,
      :multi => true

  opt :list, "List defined attacks"
  opt :steps, "List all available step definitions"
end

if opts[:steps]
  require 'gauntlt/stepdef'

  defined_steps = Gauntlt::Stepdef.definitions
  defined_steps.each {|x| puts "#{x['kind']} -- #{x['source']}"}
  exit(0)
end

opts[:path] = if ARGV.empty?
  "./**/*.attack"
else
  ARGV.join(" ")
end

if opts[:list]
  attack_list = Gauntlt.attacks.map{|s| "  #{s}"}.join("\n")
  puts "Defined attacks: #{}"
  puts attack_list
else
  Gauntlt.attack( opts[:path], opts[:tags].join(',') )
end

